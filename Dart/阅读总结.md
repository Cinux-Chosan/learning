# Dart

- 在 Dart 中，一切皆 `object`，所有 `object` 都是 `class` 实例，因此数字、函数和 `null` 都是 `object`。除了 `null`，所有 `object` 都继承自 `Object` 类

---

- 如果开启了 [null safety](https://dart.dev/null-safety)，变量不可为 `null`，除非你指定它们可以。通过在类型后面添加 `?` 来表示变量可以为 `null`。在变量后面添加 `!` 可以指明该变量不可能为 `null`

---

- 当你希望显式指定某个变量是任意类型时，可以将其指定为 `Object` 类型
  
---

- late 变量

Dart 2.12 加入了 `late` 修饰符，有两种情况需要使用：
  - 声明一个非 null 变量，但是在之后才给它初始化值
  - 懒模式初始化变量

通常 Dart 会检测到一个 non-nullable 变量在使用前初始化值。但有时候会分析失败。两种常见的情况是顶级变量和实例变量：Dart 经常不能判断它们是否被设置了值，因此它不会去检测。

如果你确定在使用的时候变量会被初始化一个值，但是 Dart 却不这么认为的时候，你可以将变量设置为 late：

```dart
late String description;

void main() {
  description = 'Feijoada!';
  print(description);
}
```

当一个变量为 `late` 的时候，它并不会立即初始化，而是在第一次使用的时候才会对它进行初始化，这有利于：
  - 变量可能并不会被用到，但是它的初始化非常耗费性能
  - 你需要初始化一个实例变量，其初始化需要用到 `this`

```dart
late String temperature = _readThermometer(); // 懒模式初始化，如果 temperature 没有使用，则 _readThermometer() 永远不会被调用
```

---

- `final` 和 `const`

  - `const` 是编译时的常量，即声明就需要初始化。

  - `final` 是运行时常量，它只能被初始化一次，不可修改

const 关键字不仅能声明常量变量，还能用于创建常量值（编译期常量）。

```dart
var foo = const [];
final bar = const [];
const baz = []; // 等于 `const []`，但非常不建议这么用，太过冗余
```

- 你可以使用类型检查、类型转换（`is` 和 `as`）、集合的 `if` 和展开操作符(`...` 和 `...?`) 来定义常量：

```dart
const Object i = 3; // Where i is a const Object with an int value...
const list = [i as int]; // 使用类型转换
const map = {if (i is int) i: "int"}; // 使用 is 和 集合 if
const set = {if (list is List<int>) ...list}; // 展开操作符
```

            final 对象无法被修改，但是其属性可以被修改。

            const 对象和其字段都不能被修改！

---

## 内置类型

---
- String

和 JavaScript 一样，当需要获得一个对象的字符串时，Dart 会调用对象的 `toString()` 方法

- 将多个字符串相邻写在一起，它们会自动组合成一个字符串，当然你也可以使用 `+` 来串联字符串

```dart
var s1 = 'String '
    'concatenation'
    " works even over line breaks.";  // 和使用 + 一样
assert(s1 ==
    'String concatenation works even over '
        'line breaks.');

var s2 = 'The + operator ' + 'works, as well.';
assert(s2 == 'The + operator works, as well.');
```

- 使用三个引号来创建多行字符串，可以是三个单引号或者双引号：

```dart
var s1 = '''
You can create
multi-line strings like this one.
''';

var s2 = """This is also a
multi-line string.""";
```

- 使用 `r` 前缀来创建原始字符串：

```dart
var s = r'In a raw string, not even \n gets special treatment.';
```
See [Runes and grapheme clusters](https://dart.dev/guides/language/language-tour#characters) for details on how to express Unicode characters in a string.


---

- list：同 JavaScript 中的数组

Dart 2.3 引入了展开操作符`...` 和 `...?`，前者不可展开 null，后者可以：

```dart
var list;
var list2 = [0, ...?list]; // 使用 ...? 时，list 可以为 null
list = [1, 2, 3];
list2 = [0, ...list]; // list 不可为 null
assert(list2.length == 4);
```

- Dart 支持`集合 if` 和 `集合 for`：

使用集合 if 来创建一个具有 3 或 4 个元素的列表：

```dart
var nav = [
  'Home',
  'Furniture',
  'Plants',
  if (promoActive) 'Outlet'
];
```

使用`集合 for` 来在从其它集合添加元素时进行预处理：

```dart
var listOfInts = [1, 2, 3];
var listOfStrings = [
  '#0',
  for (var i in listOfInts) '#$i'
];
assert(listOfStrings[1] == '#1');
```

For more details and examples of using collection if and for, see the [control flow collections proposal](https://github.com/dart-lang/language/blob/master/accepted/2.3/control-flow-collections/feature-specification.md).

The List type has many handy methods for manipulating lists. For more information about lists, see [Generics](https://dart.dev/guides/language/language-tour#generics) and [Collections](https://dart.dev/guides/libraries/library-tour#collections).

---

- Set：没有顺序的唯一值集合

```dart
// 使用字面量方式创建
var halogens = {'fluorine', 'chlorine', 'bromine', 'iodine', 'astatine'};
// 创建空集合
var names = <String>{};
Set<String> names = {}; // This works, too.
// var names = {}; // 注意：此种方式创建的是 map 而非 set，相当于 Map<dynamic, dynamic>
```

set 使用 `add()` 添加单个元素，使用 `addAll()` 添加一组元素

- Map：键和值都可以是任何类型，相同的键只能出现一次

```dart
// 类型为 Map<String, String>
var gifts = {
  // Key:    Value
  'first': 'partridge',
  'second': 'turtledoves',
  'fifth': 'golden rings'
};

// 类型为 Map<int, String>
var nobleGases = {
  2: 'helium',
  10: 'neon',
  18: 'argon',
};

// 使用 Map 构造函数，在 Dart 中 new 关键字可以省略，参考 https://dart.dev/guides/language/language-tour#using-constructors
var gifts = Map<String, String>();
gifts['first'] = 'partridge';
gifts['second'] = 'turtledoves';

// 访问元素、添加元素都和 JavaScript 一样，访问不存在的键会返回 null
assert(gifts['fifth'] == null);
```

Map 也支持 `...`、`...?` 以及`集合 if` 和 `集合 for`

---

- [Runes and grapheme clusters](https://dart.dev/guides/language/language-tour#runes-and-grapheme-clusters)

---

- [Symbol](https://dart.dev/guides/language/language-tour#symbols)

## Functions

Dart 中的函数也是对象，可以进行变量赋值和当做参数传递

基本语法：

```dart
bool isNoble(int atomicNumber) {
  return _nobleGases[atomicNumber] != null;
}
```

对于函数体只有一个表达式的情况，可以使用简写语法：

```dart
bool isNoble(int atomicNumber) => _nobleGases[atomicNumber] != null;
```

---

- Params

                一些 API 仅使用具名参数，如 Flutter Widget 构造函数

- 具名参数：

具名参数如果不是标记为`required`，则都是可选的

在调用函数的时候可以通过 `paramName: value` 的格式传递具名参数

```dart
/// Sets the [bold] and [hidden] flags ...
void enableFlags({bool? bold, bool? hidden}) {...}

enableFlags(bold: true, hidden: false);
```

            如果一个参数是可选的但是不能为 null，则请提供默认值

```dart
const Scrollbar({Key? key, required Widget child}) // 通过 required 将 child 标记为必填
```

- 可选位置参数：将参数包裹在 `[]` 中表示这些位置的参数为可选参数

```dart
String say(String from, String msg, [String? device]) { // device 为可选参数，[] 可以包裹多个参数
  var result = '$from says $msg';
  if (device != null) {
    result = '$result with a $device';
  }
  return result;
}
```

- 参数默认值：使用 `=` 在声明参数的地方给与默认值

```dart
/// Sets the [bold] and [hidden] flags ...
void enableFlags({bool bold = false, bool hidden = false}) {...}

// bold will be true; hidden will be false.
enableFlags(bold: true);
```

- 匿名函数：

```
([[Type] param1[, …]]) {
  codeBlock;
};
```

如果只有一个表达式，可以写作箭头函数：

```dart
list.forEach((item) => print('${list.indexOf(item)}: $item')); 
```

---

- 函数相等：函数严格相等才相等，相同类的实例方法在不同实例之间也是不相等的

---

- 返回值：所有函数都有返回值，如果没有指定，则会默认添加一个 `return null` 在函数结尾。

---

## Operator

            对于二元操作符而言，左边的操作数决定了使用什么方法，例如一个 Vector 对象和一个 Point 对象相加： aVector + aPoint 使用 Vector 的 + 

- 判断两个对象是否相等可以使用 `==` 操作符，少数你需要知道两个对象是否严格相等的时候使用 [identical()](https://api.dart.dev/stable/dart-core/identical.html)

---

- 类型测试操作符

| 操作符 | 含义                                |
| ------ | ----------------------------------- |
| `as`   | 类型转换                            |
| `is`   | 如果对象具有指定类型则返回 `true`   |
| `is!`  | 如果对象不是指定等类型则返回 `ture` |

`obj is T` 返回 true 的条件是 `obj` 实现了 `T` 指定的接口，如 `obj is Object` 总是 true

确定类型的时候使用 `as` 转换，不确定的时候使用 `is` 对类型进行检测。

---

- 赋值操作符

`=` 进行赋值，`??=` 表示当左边的变量为 `null` 时才赋值，否则保持原值

---

- 条件表达式

三元表达式：`condition ? expr1 : expr2` 
非空表达式：`expr1 ?? expr2`，如果 expr1 是非空的，则返回其值，否则计算并返回 expr2 的值

---

- 级联操作符 `..` 和 `?..`

级联操作符使得在同时访问相同对象的不同字段时节省代码量

```dart
var paint = Paint() // 获得一个对象
  ..color = Colors.black // 使用其属性
  ..strokeCap = StrokeCap.round
  ..strokeWidth = 5.0;
```

等同于 

```dart
var paint = Paint();
paint.color = Colors.black;
paint.strokeCap = StrokeCap.round;
paint.strokeWidth = 5.0;
```

如果操作的对象可能为 null，则第一个操作符使用 `?..`：

```dart
querySelector('#confirm')
  ?..text = 'Confirm' // 当对象可能是 null 时使用 ?..
  ..classes.add('important')
  ..onClick.listen((e) => window.alert('Confirmed!'));
```

等同于

```dart
var button = querySelector('#confirm');
button?.text = 'Confirm';
button?.classes.add('important');
button?.onClick.listen((e) => window.alert('Confirmed!'));
```

对于返回对象的函数需要小心使用级联语法：

```dart
var sb = StringBuffer();
sb.write('foo')
  ..write('bar'); // Error: method 'write' isn't defined for 'void'.
```

## [Control flow statements](https://dart.dev/guides/language/language-tour#control-flow-statements)

- For loops

Dart 中的 for 循环会捕获索引值，但 JavaScript 并不是这样：

```dart
var callbacks = [];
for (var i = 0; i < 2; i++) {
  callbacks.add(() => print(i));
}
callbacks.forEach((c) => c()); // 输出 0 和 1，但是在 JavaScript 中都是 2
```

- Break and continue

使用 [Iterable](https://api.dart.dev/stable/dart-core/Iterable-class.html) 编写会更加简单：

```dart
candidates
    .where((c) => c.yearsExperience >= 5)
    .forEach((c) => c.interview());
```

---

- Switch and case

Dart 中的 switch 使用 `==` 来比较数字、字符串或者编译期常量。比较的对象需要是相同类的实例，不可以是子类型。

每个非空 case 需要以 break 结尾。其他可用的方式还有 `continue`、`throw` 和 `return`

```dart
var command = 'OPEN';
switch (command) {
  case 'OPEN':
    executeOpen(); // 报错，非空 case 需要 break
    // ERROR: Missing break

  case 'CLOSED':
    executeClosed();
    break;
}
```

```dart
var command = 'CLOSED';
switch (command) {
  case 'CLOSED': // 空 case 可以穿透到下一个 case
  case 'NOW_CLOSED':
    // Runs for both CLOSED and NOW_CLOSED.
    executeNowClosed();
    break;
}
```

如果你真的希望穿透，可以使用 continue 配合 label：

```dart
var command = 'CLOSED';
switch (command) {
  case 'CLOSED':
    executeClosed();
    continue nowClosed;
  // Continues executing at the nowClosed label.

  nowClosed:
  case 'NOW_CLOSED':
    // Runs for both CLOSED and NOW_CLOSED.
    executeNowClosed();
    break;
}
```

## [Assert](https://dart.dev/guides/language/language-tour#assert)