# Redux 入门教程

## 前言

### 编写目的

我在刚接触 redux 项目的时候，对 redux 感到非常迷惑。我不明白为什么要使用它，也不清楚 action、reducer、store 之间是如何串联起来的。而一开始为了追求快速开发，每次都只是大概的阅览一下官方文档，但越看越懵。

现在我花了一些时间再来好好阅读 redux 文档，在此整理一篇文章，希望能够帮助到仍在 redux 边缘徘徊的朋友。

本文的目的意在帮助新手快速了解 redux **基本知识**。

## 目录

## 内容

### 为什么要使用 Redux

如果你是刚接触 redux 的迷茫小孩，那请跟着我的思路一步一步来。这里我们先从为什么要使用 redux 开始。

React 官方文档中提到一种情况，简单说来就是多层组件之间的传值问题，假设有如下层次结构的 3 个组件：

      - A
        - B
          - C

C 属于 B 的子组件，B 属于 A 的子组件。

现在组件 C 需要用到 A 中的某个值，怎么做呢？官方文档中给出的解决方案简单暴力 —— 向下传值：即 A 将值传给 B，B 再传给 C（官方文档中还提到一些其他方式，如控制反转）。这样做看似合情合理，但问题也很明显：

> - B 作为 A 到 C 传值的中转层，这部分数据对 B 来说没有任何作用
> - 随着参数个数的增加代码会变得越来越冗余，并且难以维护
> - 降低了组件 B 的灵活性

我们需要把它干掉！

怎么干掉呢？我们可以把数据从组件中抽离出来单独存放在一个对象里，假设这个对象就叫 Store（中文意思就是存储）。组件要用到对应的数据时，去 Store 中拿就 OK 了，Store 中数据如果发生了变化，通知对应的组件更新即可，现在思路就简单多了：

      - A <------------>  ---------
        - B <----------> |  Store  |
          - C <-------->  ---------
                              ^
                              |
      - D <-------------------

此时 C 还是 B 的子组件，B 还是 A 的子组件，但 A、B、C 都订阅了 Store 中的数据，此外还添加了组件 D，它同样从 Store 订阅了数据。当 ABCD 中任意一个组件 **更新** 了 Store 中的数据时，Store 就会通知所有其他组件重新获取数据。

这样一来，数据完全就可以共享了，并且还不用关心是不是在同一层级中（向下传值的情况无法解决不同层级树中组件值共享的问题）。

你如果理解了上面的模型，你其实就已经懂 Redux 了。

此外，除了解决多层组件传值的问题，redux 还有其他使用场景，如：

- 在不同的视图之间缓存数据提升访问速度
- 同一份数据可能有多个不同的 UI 展示方式时
- 防止热重载时组件内的状态数据被清除掉
- 应用越来越大，管理的数据越来越多的情况
- 在调试的时候回退数据，查看当时的数据情况

但不管怎么说，我们都能够看出来，redux 始终都是以数据为中心！

### 如何更新数据

上面我们提到 ABCD 任意一个组件都可能会 **更新** Store 中的数据，那如何更新呢？这个过程大概需要经历下面三步：

      1. 我有一个更新数据的需求
      2. 我把这个需求告诉 Store
      3. Store 根据我的需求去执行具体的更新操作

我们来对每一步做一个分解：

#### 1. 我有一个更新数据的需求

> 上面第一步 “我有一个更新数据的需求” 可以理解为 “我想要发生一个更新数据的操作”，更新即是动作，动作的英文是 **action**。
>
> 在 redux 中，我们约定用一个对象来描述一个动作，这个代表动作的对象在 redux 中就被称作 `action`。就像事件对象有一个 type 属性一个，这个对象也必须有一个 `type` 字段对它进行标识，如：
>
> ```js
> { type: "ADD_NUMBER" }
> ```
>
> 上面是一个最简单的 `action`，它只包含一个 `type` 字段，其值为我们自己定义的字符串，如用 `"ADD_NUMBER"`，表示这是一个增加数字（“Add number”）的操作（action）。
>
> 但并不是说 `action` 只能有一个 type 字段，你还可以根据自己的情况往里加，一般我们还会加一个 `payload` 字段来传递数据，但是否需要叫这个名字完全取决于你。`action` 最终会到达第三步中的 `reducer`（先别管 `reducer` 是什么），但怎么到达第三步，这就是第二步里做的事情。

#### 2. 我把这个需求告诉 Store

> 上面第二步 “我把这个需求告诉 Store” 实际上就是要将更新动作派发（或发送）给 Store，派发的英文是 **dispatch**
>
> 在 redux 中，store 就是一个存放所有数据的对象，存放的数据我们称之为 state（状态），store 和 state 的关系就如同篮子和水果的关系，篮子里面可以装很多水果，store 就是篮子，state 就是其中的水果。
>
> store 有一个叫 `dispatch` 的方法，这个方法的作用就是将 `action` 传递给 `store`，如：
>
> ```js
> store.dispatch({ type: "ADD_NUMBER" })
> ```

#### 3. Store 根据我的需求去执行具体的更新操作

> store 收到 action 之后，就需要调用对应的函数去执行这个操作。在 redux 中真正执行操作的函数叫 reducer（我们稍后会说为什么叫 reducer），现在只需要知道它的参数是当前的 state 和需要被执行的 action，返回值为新的 state。函数签名为： `(state, action) => newState`，如：
>
> ```js
> (state = 0, action) => {
>   switch (action.type) {
>     case "ADD_NUMBER":
>       return state + 1;
>     default:
>       return state;
>   }
> }
> ```
>
> 上面是一个 reducer 的示例，它满足 reducer 的几点要求：
>
> - 必须要有返回值，不能是 `undefined`
> - 如果 action 不需要在当前 reducer 中处理，则直接将之前的 state 返回（因为每个 reducer 都可以对任意 action 做出响应，redux 并不知道哪个 reducer 会处理当前 action，因此每一次 redux 都会用 action 去调用所有的 reducer，在无关的 reducer 中我们不需要对 state 做任何处理而直接返回，在上面就是 switch 中的 default）
> - state 需要有一个默认值（因为 redux 在初始化时会去调用每一个 reducer 获取对应的初始 state，此时 state 参数为 undefined，action 为 `{ type: "@@redux/INIT" }`）

      题外话：为什么叫 reducer？各位是否记得 JavaScript 数组有一个方法叫 reduce，它的参数是其上一次的执行结果和本次加入执行的数据，执行完成后返回的结果又会作为参数加入到下一轮的执行中，redux 中的 reducer 和它有异曲同工之妙，每一次调用它的第一个参数都是上一次计算得出的 state，并且每次返回的 state 都会作为下一次执行的参数。








## 参考资料

- [What Does Redux Do? (and when should you use it?)](https://daveceddia.com/what-does-redux-do/)
- [Redux vs plain React](https://stackoverflow.com/questions/39260769/redux-vs-plain-react/39261546#39261546)