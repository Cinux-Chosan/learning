# Easy Deploy with SSH

In many deployment workflows, the routine basically consists of connecting with SSH to multiple servers, git pull the latest version, then reload the app.

在许多部署过程中，基本操作流程都是使用 SSH 连接到多个服务器，使用 git pull 获取最新版本，然后重新载入 app 运行。

The PM2 deploy tool’s purpose is to automate this task.

PM2 部署工具的目的就是将这个流程自动化。

You set an array of distant hosts, a pre-deploy/post-deploy command line action, and you are done.

你需要设置一个远程主机列表，一个预部署（pre-deploy）/部署（post-deploy） 命令行操作，然后就完成了。

## 安装（Installation）

### SSH 设置（SSH setup）

Be sure that you have the public ssh key on your local machine:

确保你本地电脑上有 ssh 公钥：

```sh
ssh-keygen -t rsa
ssh-copy-id node@myserver.com
```

### 生态文件（Ecosystem file）

You first need to configure your ecosystem.config.js with all the necessary information:

首先你需要配置所有的必要信息到 ecosystem.config.js 中：

```js
module.exports = {
  apps: [{
    name: "app",
    script: "app.js"
  }],
  deploy: {
    // "production" is the environment name
    production: {
      // SSH key path, default to $HOME/.ssh
      key: "/path/to/some.pem",
      // SSH user
      user: "ubuntu",
      // SSH host
      host: ["192.168.0.13"],
      // SSH options with no command-line flag, see 'man ssh'
      // can be either a single string or an array of strings
      ssh_options: "StrictHostKeyChecking=no",
      // GIT remote/branch
      ref: "origin/master",
      // GIT remote
      repo: "git@github.com:Username/repository.git",
      // path in the server
      path: "/var/www/my-repository",
      // Pre-setup command or path to a script on your local machine
      pre-setup: "apt-get install git ; ls -la",
      // Post-setup commands or path to a script on the host machine
      // eg: placing configurations in the shared dir etc
      post-setup: "ls -la",
      // pre-deploy action
      pre-deploy-local: "echo 'This is a local executed command'"
      // post-deploy action
      post-deploy: "npm install",
    },
  }
}
```

            To get more information about the deploy options, check the ecosystem file reference.

            想查看更多关于部署参数项的信息可以参考生态文件部分。


            Note that the distant path must be empty as it will be populated by pm2 deploy.

            注意，远程路径必须为空，因为它将由 pm2 进行填充。

### 设置（Setup）

Make your first deploy and populate the distant path with:

开始你的第一次部署，将远程路径填充为：

```sh
pm2 deploy production setup
```

### 部署（Deploy）

Here are some useful commands:

先看几个有用的命令：

```sh
# Setup deployment at remote location
pm2 deploy production setup

# Update remote version
pm2 deploy production update

# Revert to -1 deployment
pm2 deploy production revert 1

# execute a command on remote servers
pm2 deploy production exec "pm2 reload all"
```

## 部署选项（Deployment options）

Display deploy help via `pm2 deploy help`:

通过 `pm2 deploy help` 查看部署帮助：

```sh
pm2 deploy <configuration_file> <environment> <command>

  Commands:
    setup                run remote setup commands
    update               update deploy to the latest release
    revert [n]           revert to [n]th last deployment or 1
    curr[ent]            output current release commit
    prev[ious]           output previous release commit
    exec|run <cmd>       execute the given <cmd>
    list                 list previous deploy commits
    [ref]                deploy to [ref], the "ref" setting, or latest tag
```

## 强制部署（Force deployment）

You may get this message:

你可能会看到如下消息：

```sh
--> Deploying to dev environment
--> on host 192.168.1.XX

  push your changes before deploying

Deploy failed
```

That means that you have changes in your local system that aren’t pushed inside your git repository, and since the deploy script get the update via `git pull` they will not be on your server. If you want to deploy without pushing any data, you can append the `--force` option:

这意味着你本地有未提交到 git 仓库的修改，因此当部署脚本通过 `git pull` 获取更新的时候并不能成功。如果你希望直接部署而不提交任何数据，你可以添加 `--force` 选项：

```sh
pm2 deploy ecosystem.json production --force
```

## 考量（Considerations）

- You can use the option `--force` to skip local change detection
- Verify that your remote server has the permission to git clone the repository
- You can declare specific environment variables depending on the environment you want to deploy the code to. For instance to declare variables for the production environment, add “env_production”: {} and declare the variables.
- You can embed the “apps” & “deploy” section in the package.json

- 你可以使用 `--force` 跳过对本地文件修改的检测
- 确保你的远程服务器有 git 仓库的克隆权限
- 你能够根据你想部署代码的环境声明特定的环境变量。例如给生产（production）环境声明变量，添加  “env_production”: {} 并声明变量。
- 你可以在 package.json 中嵌入 “apps” & “deploy” 段（section）。

## SSH克隆错误（SSH clone errors）